---
id: 13
tags: [security, modules, user-infra-d1, d1, drizzle]
title: "@modules/user-infra-d1セキュリティレビュー — 問題なし"
created_at: 2026-03-01T00:00:00+09:00
updated_at: 2026-03-01T00:00:00+09:00
related_to: [010-todo-infra-d1-security-review]
---

# @modules/user-infra-d1セキュリティレビュー — 問題なし

## 背景

`@modules/user-infra-d1` はユーザードメインのD1（SQLite）永続化アダプター。Drizzle ORMを使い、`D1UserRepository` を実装する。`findBySub()` と `save()` の2操作のみを提供する48行の単一ファイル構成。データベースに直接アクセスする層のため、インジェクション脆弱性や機密情報漏洩のリスクが最も高いレイヤー。

## レビュー結果

### 問題なし（全項目）

| チェック項目               | 結果                                                                                                                                                                         |
| -------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **入力バリデーション**     | 入力バリデーションはこの層の責務外。ドメイン層で実施済みの値のみが渡される                                                                                                   |
| **認証・認可**             | リポジトリ層は認証・認可を扱わない。呼び出し元（アプリケーション層）の責務                                                                                                   |
| **インジェクション脆弱性** | Drizzle ORMのクエリビルダーを使用。`eq()`, `insert()`, `onConflictDoUpdate()` — 全パラメータはパラメタライズドクエリとして処理され、SQLインジェクションリスクなし。生SQLなし |
| **機密情報の取り扱い**     | `mapRecordToUser()` で `createdAt`/`updatedAt` を除外しドメインオブジェクトに変換。ログ出力なし。エラーメッセージに機密情報の漏洩なし                                        |
| **依存パッケージ**         | ランタイム依存は `drizzle-orm` のみ。広く利用されているORMで既知の重大脆弱性なし                                                                                             |
| **OWASP Top 10**           | 該当するリスクなし                                                                                                                                                           |

### 記録のみ（修正不要）

- **楽観的ロック**: `version` フィールドを保持・保存しているが、更新時のversionチェック（CAS）はこの層では実施していない。これはドメイン層の責務として妥当
- **タイムスタンプ生成**: `new Date().toISOString()` でアプリケーション側のタイムスタンプを使用。DBのサーバータイムスタンプではないが、D1（SQLite）では標準的なアプローチ
- **UPSERT戦略**: `onConflictDoUpdate({ target: usersTable.id })` による `id` ベースのUPSERTを使用。`sub` の一意制約はDBスキーマ側で保証される前提
